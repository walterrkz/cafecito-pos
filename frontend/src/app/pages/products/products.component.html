<section class="products-wrapper">
  @if (authService.isAuthenticated && authService.isAdmin) {
    <div class="mode-bar">
      <button class="mode-toggle" (click)="toggleViewMode()">
        Switch to {{ viewMode === "admin" ? "Vendor" : "Admin" }} View
      </button>

      @if (viewMode === "admin") {
        <button class="create-button" (click)="showCreateModal = true">
          Create Product
        </button>
      }
    </div>
  }

  <div class="filters">
    <div class="filter-group search-group">
      <label>Search</label>
      <input type="text" [(ngModel)]="search" (input)="loadProducts()" />
    </div>

    <div class="filter-group small-group">
      <label>Page</label>
      <input
        type="number"
        min="1"
        step="1"
        [(ngModel)]="page"
        (change)="loadProducts()"
      />
    </div>

    <div class="filter-group small-group">
      <label>Limit</label>
      <input
        type="number"
        min="1"
        max="100"
        step="1"
        [(ngModel)]="limit"
        (change)="loadProducts()"
      />
    </div>
  </div>

  @if (loading) {
    <p class="state-message">Loading products...</p>
  }

  @if (errors.length && !loading) {
    <div class="error-box">
      @for (error of errors; track error) {
        <p class="error-message">{{ error }}</p>
      }
    </div>
  }

  @if (!loading && !errors.length) {
    <p class="results-info">
      Showing {{ products.length }} of {{ total }} products
    </p>

    @if (products.length === 0) {
      <p class="state-message">No products found</p>
    } @else {
      <div class="products-grid">
        @for (product of products; track product.id) {
          <app-product-card
            [product]="product"
            [isAuth]="authService.isAuthenticated"
            [isAdmin]="authService.isAdmin"
            [viewMode]="viewMode"
            (edit)="openEditModal($event)"
            (delete)="openDeleteModal($event)"
          ></app-product-card>
        }
      </div>
    }
  }
</section>

<!-- ================================
     CREATE MODAL
================================== -->

@if (showCreateModal) {
  <app-modal (close)="resetCreateModal()">
    @if (!createSuccess) {
      <h3>Create Product</h3>

      @if (createErrors.length) {
        <div class="error-box">
          @for (error of createErrors; track error) {
            <p class="error-message">{{ error }}</p>
          }
        </div>
      }

      <div class="form-group">
        <label>Name</label>
        <input type="text" [(ngModel)]="newName" />
      </div>

      <div class="form-group">
        <label>Price</label>
        <input type="number" step="0.01" [(ngModel)]="newPrice" />
      </div>

      <div class="form-group">
        <label>Stock</label>
        <input type="number" [(ngModel)]="newStock" />
      </div>

      <div class="modal-actions">
        <button
          class="primary"
          (click)="createProduct()"
          [disabled]="createLoading"
        >
          {{ createLoading ? "Creating..." : "Create" }}
        </button>
        <button (click)="resetCreateModal()">Cancel</button>
      </div>
    } @else {
      <div class="success-screen" (click)="resetCreateModal()">
        <h3>Product created successfully</h3>
        <p>Click anywhere to close</p>
      </div>
    }
  </app-modal>
}

<!-- ================================
     EDIT MODAL
================================== -->

@if (showEditModal) {
  <app-modal (close)="resetEditModal()">
    @if (!editSuccess) {
      <h3>Edit {{ editName }}</h3>
      <p class="modal-id">ID: {{ editId }}</p>

      @if (editErrors.length) {
        <div class="error-box">
          @for (error of editErrors; track error) {
            <p class="error-message">{{ error }}</p>
          }
        </div>
      }

      <div class="form-group">
        <label>Price</label>
        <input type="number" step="0.01" [(ngModel)]="editPrice" />
      </div>

      <div class="form-group">
        <label>Stock</label>
        <input type="number" [(ngModel)]="editStock" />
      </div>

      <div class="modal-actions">
        <button
          class="primary"
          (click)="updateProduct()"
          [disabled]="editLoading"
        >
          {{ editLoading ? "Updating..." : "Update" }}
        </button>
        <button (click)="resetEditModal()">Cancel</button>
      </div>
    } @else {
      <div class="success-screen" (click)="resetEditModal()">
        <h3>Product updated successfully</h3>
        <p>Click anywhere to close</p>
      </div>
    }
  </app-modal>
}

<!-- ================================
     DELETE MODAL
================================== -->

@if (showDeleteModal) {
  <app-modal (close)="resetDeleteModal()">
    @if (!deleteSuccess) {
      <h3>Delete Product</h3>
      <p class="modal-id">ID: {{ deleteId }}</p>
      <p class="delete-warning">
        Are you sure you want to delete <strong>{{ deleteName }}</strong
        >?
      </p>

      @if (deleteErrors.length) {
        <div class="error-box">
          @for (error of deleteErrors; track error) {
            <p class="error-message">{{ error }}</p>
          }
        </div>
      }

      <div class="modal-actions">
        <button
          class="danger"
          (click)="deleteProduct()"
          [disabled]="deleteLoading"
        >
          {{ deleteLoading ? "Deleting..." : "Delete" }}
        </button>
        <button (click)="resetDeleteModal()">Cancel</button>
      </div>
    } @else {
      <div class="success-screen" (click)="resetDeleteModal()">
        <h3>Product deleted successfully</h3>
        <p>Click anywhere to close</p>
      </div>
    }
  </app-modal>
}
